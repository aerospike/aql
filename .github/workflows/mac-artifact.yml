name: Mac Artifact Simplified

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write
  issues: write
  discussions: write
  packages: write
  deployments: write
  id-token: write

on:
  push:
    branches: [actionsHub, main, "*-bugfix"]
  pull_request:
    branches: [main]

jobs:
  extract-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Extract Version
        id: extract
        uses: aerospike/shared-workflows/.github/actions/extract-version-from-tag@main
        with:
          version-file: .github/workflows/VERSION.example
    outputs:
      version: ${{ steps.extract.outputs.version }}
      git_tag: ${{ steps.extract.outputs.git_tag }}
  # reusable_execute-build.yaml is a reusable workflow that enables building the project. This step
  # could be done another way, but the advantage of using the reusable workflow is that it allows
  # a single workflow that can be instrumented in the future.
  # This is also an example of using a matrix strategy to build in GHA
  build-aql:
    uses: aerospike/shared-workflows/.github/workflows/reusable_execute-build.yaml@main
    needs: extract-version
    # Matrix strategy: Multi-platform builds across Ubuntu/Debian/RPM families (x86_64 native, ARM64 emulated)
    strategy:
      matrix:
        os: [macos-13, macos-14, macos-15]
        include:
          - os: macos-13
            openssl-path: /usr/local/opt/openssl           # Intel Homebrew prefix
            target-dir: target/Darwin-x86_64/bin
          - os: macos-14
            openssl-path: /opt/homebrew/opt/openssl        # Apple Silicon prefix
            target-dir: target/Darwin-arm64/bin
          - os: macos-15
            openssl-path: /opt/homebrew/opt/openssl
            target-dir: target/Darwin-arm64/bin
    with:
      runs-on: ${{ matrix.os }}
      jf-project: database
      jf-build-name: aql
      jf-build-id: ${{ github.run_number }}-buildinfo-${{ matrix.os }}
      gh-workflows-ref: v2.0.0 # use v2.0.1 once it is released
      build-script: |
        brew update
        brew install automake libtool pkg-config openssl@3 || true
        echo "pwd: $(pwd)"
        echo "ls -laht"
        ls -laht
        make OPENSSL_STATIC_PATH="${{ matrix.openssl-path }}/lib"
        # Sanity test the aql tool just checks if it starts up.
        ${{ matrix.target-dir }}/aql -e "info" 2>&1 | grep "Failed to connect"
      gh-artifact-directory: ${{ matrix.target-dir }}
      gh-artifact-name: build-artifacts-${{ matrix.os }}
      oidc-provider-name: database-gh-aerospike
      oidc-audience: database-gh-aerospike
      publish-build-info: true
      dry-run: false # default
  upload-artifacts:
    uses: aerospike/shared-workflows/.github/workflows/reusable_deploy-artifacts.yaml@main
    needs: [build-aql, extract-version]
    with:
      jf-project: database
      jf-build-name: aql
      jf-build-id: ${{ github.run_number }}
      jf-metadata-build-id: ${{ github.run_number }}-metadata
      gh-workflows-ref: v2.0.0
      version: ${{ needs.extract-version.outputs.version }}
      oidc-provider-name: database-gh-aerospike
      oidc-audience: database-gh-aerospike
      gh-artifact-name: build-artifacts
      gh-retention-days: 1
      dry-run: false

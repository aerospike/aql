name: Mac Artifact Simplified

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write
  issues: write
  discussions: write
  packages: write
  deployments: write

on:
  push:
    branches: [actionsHub, main, "*-bugfix"]
  pull_request:
    branches: [main]

jobs:
  build:
    strategy:
      matrix:
        os: [macos-13, macos-14, macos-15]
        include:
          - os: macos-13
            openssl-path: /usr/local/opt/openssl           # Intel Homebrew prefix
            target-dir: target/Darwin-x86_64/bin
          - os: macos-14
            openssl-path: /opt/homebrew/opt/openssl        # Apple Silicon prefix
            target-dir: target/Darwin-arm64/bin
          - os: macos-15
            openssl-path: /opt/homebrew/opt/openssl
            target-dir: target/Darwin-arm64/bin

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout (repo + submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Print version
        id: tag
        run: |
          git describe --tags --always
          echo "tag=$(git describe --tags --always)" >> "$GITHUB_OUTPUT"

      # Prepare a clean runner with just the required build tools
      - name: Install build dependencies
        run: |
          brew update
          brew install automake libtool pkg-config openssl@3 || true
          echo "PKG_CONFIG_PATH=$(pkg-config --variable pc_path pkg-config):${{ matrix.openssl-path }}/lib/pkgconfig" >> $GITHUB_ENV
          echo "OPENSSL_STATIC_PATH=${{ matrix.openssl-path }}/lib" >> $GITHUB_ENV

      - name: Build aql
        env:
          OPENSSL_STATIC_PATH: ${{ env.OPENSSL_STATIC_PATH }}
        run: |
          make OPENSSL_STATIC_PATH="${OPENSSL_STATIC_PATH}"

      - name: Sanity Test
        run: |
          ls target
          cd ${{ matrix.target-dir }}
          ./aql -e "info" 2>&1 | grep "Failed to connect"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-aql-${{ steps.tag.outputs.tag }}
          path: ${{ matrix.target-dir }}/aql
          if-no-files-found: error
          retention-days: 7
